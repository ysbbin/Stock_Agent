<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ“ˆ ì£¼ì‹ ë¦¬ì„œì¹˜ ì—ì´ì „íŠ¸ â€” ëŒ€ì‹œë³´ë“œ</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Malgun Gothic', -apple-system, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container { max-width: 1200px; margin: 0 auto; }
    .header {
      background: rgba(255,255,255,0.95);
      padding: 24px 32px;
      border-radius: 16px;
      margin-bottom: 24px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.12);
    }
    .header h1 { font-size: 28px; color: #1a73e8; margin-bottom: 8px; }
    .header p { color: #666; font-size: 14px; }
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      margin-bottom: 24px;
    }
    @media (max-width: 768px) { .grid { grid-template-columns: 1fr; } }
    .card {
      background: rgba(255,255,255,0.95);
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
    }
    .card h2 {
      font-size: 18px;
      color: #1a73e8;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 2px solid #e8f0fe;
    }
    .form-group { margin-bottom: 16px; }
    .form-group label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: #333;
      margin-bottom: 6px;
    }
    .form-group input, .form-group textarea {
      width: 100%;
      padding: 10px 14px;
      border: 1.5px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      transition: border .2s;
    }
    .form-group input:focus, .form-group textarea:focus {
      outline: none;
      border-color: #1a73e8;
    }
    .pw-wrapper { position: relative; display: flex; align-items: center; }
    .pw-wrapper input { padding-right: 44px !important; }
    .pw-toggle {
      position: absolute; right: 10px;
      background: none; border: none; cursor: pointer;
      padding: 4px; color: #888; font-size: 16px;
      line-height: 1; border-radius: 4px; transition: color .2s;
    }
    .pw-toggle:hover { color: #1a73e8; }

    .btn {
      padding: 11px 24px; border: none; border-radius: 8px;
      font-size: 14px; font-weight: 600; cursor: pointer; transition: all .2s;
    }
    .btn-primary { background: #1a73e8; color: white; }
    .btn-primary:hover { background: #1557b0; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(26,115,232,0.3); }
    .btn-secondary { background: #5f6368; color: white; margin-left: 8px; }
    .btn-secondary:hover { background: #3c4043; }
    .btn-success { background: #34a853; color: white; }
    .btn-success:hover { background: #2d8e47; }
    .btn-sm { padding: 7px 14px; font-size: 13px; }
    .alert {
      padding: 12px 16px; border-radius: 8px;
      margin-bottom: 16px; font-size: 14px; display: none;
    }
    .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .alert-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

    .full-width { grid-column: 1 / -1; }

    /* êµ¬ë…ì ê´€ë¦¬ í…Œì´ë¸” */
    .user-table { width: 100%; border-collapse: collapse; font-size: 13px; }
    .user-table th {
      background: #f0f4f8; padding: 10px 14px;
      text-align: left; color: #555; font-weight: 700;
      border-bottom: 2px solid #e0e0e0;
    }
    .user-table td { padding: 10px 14px; border-bottom: 1px solid #eee; vertical-align: middle; }
    .user-table tr:last-child td { border-bottom: none; }
    .badge-active   { background: #e6f4ea; color: #2d8e47; padding: 3px 10px; border-radius: 10px; font-size: 12px; font-weight: 700; }
    .badge-inactive { background: #fce8e6; color: #c5221f; padding: 3px 10px; border-radius: 10px; font-size: 12px; font-weight: 700; }
    .tag-list { display: flex; flex-wrap: wrap; gap: 4px; }
    .tag { background: #f0f4f8; color: #444; padding: 2px 8px; border-radius: 8px; font-size: 11px; }
    .user-link {
      display: inline-block; margin-top: 8px; padding: 8px 16px;
      background: #e8f0fe; color: #1a73e8; border-radius: 8px;
      font-size: 13px; font-weight: 600; text-decoration: none;
    }
    .user-link:hover { background: #1a73e8; color: #fff; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ“ˆ ì£¼ì‹ ë¦¬ì„œì¹˜ ì—ì´ì „íŠ¸</h1>
      <p>Gemini 2.5 Flash â€¢ ì›¹ ëŒ€ì‹œë³´ë“œ</p>
    </div>

    <div id="alert" class="alert"></div>

    <div class="grid">

      <!-- 1. API í‚¤ -->
      <div class="card">
        <h2>ğŸ”‘ Gemini API í‚¤</h2>
        <div class="form-group">
          <label>API Key (aistudio.google.com)</label>
          <input type="password" id="gemini_key" value="{{ config.gemini_api_key }}" placeholder="AIza...">
        </div>
        <button class="btn btn-primary" onclick="saveConfig()">ğŸ’¾ ì €ì¥</button>
      </div>

      <!-- 2. Gmail ì„¤ì • -->
      <div class="card">
        <h2>ğŸ“§ Gmail ì•Œë¦¼ ì„¤ì •</h2>
        <div class="form-group">
          <label>Gmail ì£¼ì†Œ</label>
          <input type="email" id="gmail_user" value="{{ config.gmail_user }}" placeholder="yourname@gmail.com">
        </div>
        <div class="form-group">
          <label>ì•± ë¹„ë°€ë²ˆí˜¸ (16ìë¦¬)</label>
          <div class="pw-wrapper">
            <input type="password" id="gmail_pw" value="{{ config.gmail_app_password }}" placeholder="abcdefghijklmnop">
            <button type="button" class="pw-toggle" onclick="togglePwVisibility()" title="ë¹„ë°€ë²ˆí˜¸ í‘œì‹œ/ìˆ¨ê¸°ê¸°">ğŸ‘</button>
          </div>
        </div>
        <div class="form-group">
          <label>ìˆ˜ì‹  ì£¼ì†Œ (ë¹„ì›Œë‘ë©´ ìì‹ ì—ê²Œ)</label>
          <input type="email" id="email_recipient" value="{{ config.email_recipient }}" placeholder="ì„ íƒì‚¬í•­">
        </div>
        <button class="btn btn-primary" onclick="saveConfig()">ğŸ’¾ ì €ì¥</button>
        <button class="btn btn-secondary" onclick="testEmail()">ğŸ“¨ í…ŒìŠ¤íŠ¸ ì „ì†¡</button>
      </div>

      <!-- 3. êµ¬ë…ì ê´€ë¦¬ -->
      <div class="card full-width">
        <h2>ğŸ‘¥ êµ¬ë…ì ê´€ë¦¬</h2>
        <p style="font-size:13px;color:#666;margin-bottom:12px">
          ê°€ì¡±/ì§€ì¸ì—ê²Œ ì•„ë˜ ë§í¬ë¥¼ ê³µìœ í•˜ë©´ ì§ì ‘ êµ¬ë… ì‹ ì²­í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          <br>
          <a class="user-link" href="/user" target="_blank">ğŸ”— êµ¬ë… ì‹ ì²­ í˜ì´ì§€ ì—´ê¸°</a>
        </p>
        <div id="users-table-wrapper">
          <p style="color:#999;text-align:center;padding:20px">ë¡œë”© ì¤‘...</p>
        </div>
      </div>


    </div>
  </div>

  <script>
    // â”€â”€ ì„¤ì • ì €ì¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function togglePwVisibility() {
      const input = document.getElementById('gmail_pw');
      const btn = input.nextElementSibling;
      if (input.type === 'password') {
        input.type = 'text'; btn.textContent = 'ğŸ™ˆ'; btn.title = 'ë¹„ë°€ë²ˆí˜¸ ìˆ¨ê¸°ê¸°';
      } else {
        input.type = 'password'; btn.textContent = 'ğŸ‘'; btn.title = 'ë¹„ë°€ë²ˆí˜¸ í‘œì‹œ';
      }
    }

    function showAlert(message, type) {
      const el = document.getElementById('alert');
      el.className = `alert alert-${type}`;
      el.textContent = message;
      el.style.display = 'block';
      setTimeout(() => el.style.display = 'none', 4000);
    }

    async function saveConfig() {
      const data = {
        gemini_api_key: document.getElementById('gemini_key').value,
        gmail_user: document.getElementById('gmail_user').value,
        gmail_app_password: document.getElementById('gmail_pw').value,
        email_recipient: document.getElementById('email_recipient').value,
      };
      const res = await fetch('/api/save_config', {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
      });
      const json = await res.json();
      showAlert(json.message, json.success ? 'success' : 'error');
    }

    async function testEmail() {
      const res = await fetch('/api/test_email', {method: 'POST'});
      const json = await res.json();
      showAlert(json.message, json.success ? 'success' : 'error');
    }

    // â”€â”€ êµ¬ë…ì ê´€ë¦¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadUsers() {
      const res = await fetch('/api/users');
      const users = await res.json();
      const wrapper = document.getElementById('users-table-wrapper');
      if (!users.length) {
        wrapper.innerHTML = '<p style="color:#999;text-align:center;padding:20px">ì•„ì§ êµ¬ë…ìê°€ ì—†ìŠµë‹ˆë‹¤.<br>êµ¬ë… ì‹ ì²­ í˜ì´ì§€ ë§í¬ë¥¼ ê³µìœ í•˜ì„¸ìš”!</p>';
        return;
      }
      const rows = users.map(u => {
        const h = String(u.schedule_hour ?? 'â€”').padStart(2, '0');
        const m = String(u.schedule_minute ?? 'â€”').padStart(2, '0');
        const timeStr = (u.schedule_hour != null) ? `${h}:${m}` : 'â€”';
        return `
        <tr id="row-${u.id}">
          <td style="font-weight:600">${u.name}</td>
          <td style="color:#555">${u.email}</td>
          <td style="color:#1a73e8;font-weight:600;white-space:nowrap">â° ${timeStr}</td>
          <td><div class="tag-list">${(u.stocks||[]).map(s=>`<span class="tag">${s}</span>`).join('') || 'â€”'}</div></td>
          <td><div class="tag-list">${(u.industries||[]).map(i=>`<span class="tag" style="background:#e6f4ea">${i}</span>`).join('') || 'â€”'}</div></td>
          <td><span class="${u.active ? 'badge-active' : 'badge-inactive'}" id="badge-${u.id}">${u.active ? 'í™œì„±' : 'ë¹„í™œì„±'}</span></td>
          <td style="white-space:nowrap">
            <button class="btn btn-sm btn-secondary" onclick="toggleUser('${u.id}')">${u.active ? 'â¸ ì •ì§€' : 'â–¶ ì¬ê°œ'}</button>
            <button class="btn btn-sm" style="background:#34a853;color:#fff;margin-left:6px" onclick="sendNowUser('${u.id}','${u.name}')">âš¡ ì „ì†¡</button>
            <button class="btn btn-sm" style="background:#ea4335;color:#fff;margin-left:6px" onclick="deleteUser('${u.id}','${u.name}')">ğŸ—‘</button>
          </td>
        </tr>`;
      }).join('');
      wrapper.innerHTML = `
        <table class="user-table">
          <thead><tr>
            <th>ì´ë¦„</th><th>ì´ë©”ì¼</th><th>ì „ì†¡ ì‹œê°„</th><th>ê´€ì‹¬ ì¢…ëª©</th><th>ê´€ì‹¬ ì‚°ì—…</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th>
          </tr></thead>
          <tbody>${rows}</tbody>
        </table>`;
    }

    async function toggleUser(uid) {
      const res = await fetch(`/api/users/${uid}/toggle`, {method: 'POST'});
      const json = await res.json();
      showAlert(json.message, json.success ? 'success' : 'error');
      if (json.success) loadUsers();
    }

    async function sendNowUser(uid, name) {
      if (!confirm(`${name}ë‹˜ê»˜ ì§€ê¸ˆ ë°”ë¡œ ë¦¬í¬íŠ¸ë¥¼ ì „ì†¡í• ê¹Œìš”?\nì•½ 2~3ë¶„ ì†Œìš”ë©ë‹ˆë‹¤.`)) return;
      const res = await fetch(`/api/send_now/${uid}`, {method: 'POST'});
      const json = await res.json();
      showAlert(json.message, json.success ? 'success' : 'error');
    }

    async function deleteUser(uid, name) {
      if (!confirm(`'${name}'ë‹˜ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
      const res = await fetch(`/api/users/${uid}`, {method: 'DELETE'});
      const json = await res.json();
      showAlert(json.message, json.success ? 'success' : 'error');
      if (json.success) loadUsers();
    }

    loadUsers();
  </script>
</body>
</html>
